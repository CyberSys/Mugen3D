local M = {}

function M:Init(transform)
    self.transform = transform
	self.prefabLittleHead = transform:Find("AllCharacter/LittleHead").gameObject
	self.grid = transform:Find("AllCharacter/Viewport/Grid")
	self.curCharacterP1 = {}
	self.curCharacterP1.labelName = transform:Find("CurrentCharacterP1/LabelName"):GetComponent("Text")
	self.curCharacterP1.img = transform:Find("CurrentCharacterP1/ImgMediumHead"):GetComponent("Image")
	self.curCharacterP2 = {}
	self.curCharacterP2.labelName = transform:Find("CurrentCharacterP2/LabelName"):GetComponent("Text")
	self.curCharacterP2.img = transform:Find("CurrentCharacterP2/ImgMediumHead"):GetComponent("Image")
	self.characterList  = {}
	
	self:CreateAllCharacter()
	
	self.p1Selected = 1
	self.p2Selected = 1
	self:updateP1Select(1)
	self:updateP2Select(1)
end

function M:CreateAllCharacter()
    for k, v in ipairs(CSV.Character) do
	    local go = CS.UnityEngine.GameObject.Instantiate(self.prefabLittleHead, self.grid)
		go:SetActive(true)
		local character = {}
		character.id = v._VALUE
		character.go = go
		character.imgNormalFrame = go.transform:Find("Pos/ImgFrame"):GetComponent("Image")
		character.imgP1Select = go.transform:Find("Pos/ImgP1Select"):GetComponent("Image")
		character.imgP2Select = go.transform:Find("Pos/ImgP2Select"):GetComponent("Image")
		character.imgHead = go.transform:Find("Pos/ImgHead"):GetComponent("Image")
		character.imgHead.sprite = CS.SpriteLoader.Instance:GetSprite(v.LittleHead)
		self.characterList[character.id] = character
	end
end

function M:updateP1Select(characterId)
   local lastCharacter = self.characterList[self.p1Selected]
   local curCharacter = self.characterList[characterId]
   self.p1Selected = characterId
   lastCharacter.imgP1Select.gameObject:SetActive(false)
   curCharacter.imgP1Select.gameObject:SetActive(true)
   
    self.curCharacterP1.labelName.text = CSV.Character[self.p1Selected].Name
	self.curCharacterP1.img.sprite = CS.SpriteLoader.Instance:GetSprite(CSV.Character[self.p1Selected].MediumHead)
end

function M:updateP2Select(characterId)
   local lastCharacter = self.characterList[self.p2Selected]
   local curCharacter = self.characterList[characterId]
   self.p2Selected = characterId
   lastCharacter.imgP2Select.gameObject:SetActive(false)
   curCharacter.imgP2Select.gameObject:SetActive(true)
   
    self.curCharacterP2.labelName.text = CSV.Character[self.p2Selected].Name
	self.curCharacterP2.img.sprite = CS.SpriteLoader.Instance:GetSprite(CSV.Character[self.p2Selected].MediumHead)
end

function M:Update()
    if CS.UnityEngine.Input.GetKeyDown(CS.UnityEngine.KeyCode.A) then
	    local characterId = self.p1Selected - 1
		if characterId <= 0 then
		    characterId = 3
		end
		self:updateP1Select(characterId)
	elseif CS.UnityEngine.Input.GetKeyDown(CS.UnityEngine.KeyCode.D) then
	    local characterId = self.p1Selected + 1
		if characterId >= 4 then
		    characterId = 1
		end
		self:updateP1Select(characterId)
	end
	if CS.UnityEngine.Input.GetKeyDown(CS.UnityEngine.KeyCode.LeftArrow) then
	    local characterId = self.p2Selected - 1
		if characterId <= 0 then
		    characterId = 3
		end
		self:updateP2Select(characterId)
	elseif CS.UnityEngine.Input.GetKeyDown(CS.UnityEngine.KeyCode.RightArrow) then
	    local characterId = self.p2Selected + 1
		if characterId >= 4 then
		    characterId = 1
		end
		self:updateP2Select(characterId)
	end
	
end

return M