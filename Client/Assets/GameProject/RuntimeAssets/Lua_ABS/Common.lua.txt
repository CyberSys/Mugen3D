local Enums = require "Lua_ABS/Enums"
local M = {}

--[[
M[] = {
	onEnter = function(_ENV)
	  --to do	
	end,
	onUpdate = function(_ENV)	
	  --to do
	end,
}
--]]

local function handleChangeFacing(_ENV)
	local facing = 1
	local x,y = P2Dist()
	if x < 0 then
		facing = -1
	end
	if Facing() ~= facing and PhysicsType() ~= Enums.PhysicsType.A then
		if Ctrl() then
			if PhysicsType() == Enums.PhysicsType.S and StateNo() ~= 5 then
			    ChangeState(5) 
		    elseif PhysicsType() == Enums.PhysicsType.C and StateNo() ~= 6 then
			    ChangeState(6)
		    end
		end
	end
end

M[-1] = {
	onUpdate = function(_ENV)
	    handleChangeFacing(_ENV)
	    if Ctrl() and PhysicsType() == Enums.PhysicsType.S and CommandTest("FF") and StateNo() ~= 100 then
			ChangeState(100)
		end
		if Ctrl() and PhysicsType() == Enums.PhysicsType.S and CommandTest("BB") then
			ChangeState(105)
		end
		if Ctrl() and PhysicsType() == Enums.PhysicsType.S and CommandTest("holdup") then
			ChangeState(40) --jump
		end
	    if Ctrl() and PhysicsType() == Enums.PhysicsType.S and (CommandTest("holdfwd") or CommandTest("holdback")) and StateNo() ~= 100 and StateNo() ~= 20 then
			ChangeState(20) --walk
		end
		if Ctrl() and PhysicsType() == Enums.PhysicsType.S and CommandTest("holddown")  then
			ChangeState(10)
		end
		local x,y = P2Dist()
		if Ctrl() and MoveType() ~= Enums.MoveType.D and P2MoveType() == Enums.MoveType.A and math.abs(x) < 4 and CommandTest("holdback") then
			ChangeState(120)
		end
	end,
}

M[0] = {
    onEnter = function(_ENV)
        MoveTypeSet(Enums.MoveType.I)
        PhysicsSet(Enums.PhysicsType.S)
		CtrlSet(true)
        ChangeAnim(0)
        VelSet(0,0)
	end,
	onUpdate = function(_ENV)
	    
	end,
}

--turn stand
M[5] = {
	onEnter = function(_ENV)
	    MoveTypeSet(Enums.MoveType.I)
        PhysicsSet(Enums.PhysicsType.S)
		CtrlSet(false)	
	    ChangeAnim(5)
	    ChangeFacing(-Facing())
	end,
	
	onUpdate = function(_ENV)
	    if LeftAnimTime() <= 0 then
	        ChangeState(0)
	    end
	end,
}

--turn crouch
M[6] = {
	onEnter = function(_ENV)
	    MoveTypeSet(Enums.MoveType.I)
        PhysicsSet(Enums.PhysicsType.C)
		CtrlSet(false)
		ChangeFacing(-Facing())
	    ChangeAnim(6)
	end,
	
	onUpdate = function(_ENV)
	    if LeftAnimTime() <= 0 then
	        ChangeState(11)
	    end
	end,
}

--stand to crouch
M[10] = {
	onEnter = function(_ENV)
	    PhysicsSet(Enums.PhysicsType.C)
	    CtrlSet(true)
	    if AnimExist(10) then
	        ChangeAnim(10)
	    else
	    	ChangeState(0)
	    end
	end,
	onUpdate = function(_ENV)
	    if LeftAnimTime() <= 0 then
	        ChangeState(11)
	    end
	end,
}

--crouch
M[11] = {
	onEnter = function(_ENV)
	    MoveTypeSet(Enums.MoveType.I)
	    PhysicsSet(Enums.PhysicsType.C)
	    VelSet(0, 0)
	    CtrlSet(true)
	    if AnimExist(11) then
	        ChangeAnim(11)
	    else
	    	ChangeState(0)
	    end
	end,
	onUpdate = function(_ENV)
	    if not CommandTest("holddown") then
	    	ChangeState(12)
	    end
	end,
}

--crouch to stand
M[12] = {
    onEnter = function(_ENV)
        PhysicsSet(Enums.PhysicsType.S)
        CtrlSet(true)
	    if AnimExist(12) then
	        ChangeAnim(12)
	    else
	    	ChangeState(0)
	    end
	end,
	onUpdate = function(_ENV)
	     if LeftAnimTime() <= 0 then
	    	ChangeState(0)
	    end
	end,
}

--walk
M[20] = {
	onEnter = function(_ENV)
		CtrlSet(true)
	end,
    onUpdate = function(_ENV)
        if CommandTest("holdfwd")  then
        	if Anim() ~= 20 then
        		ChangeAnim(20)
        	end
        	VelSet(2.5, 0)
        elseif CommandTest("holdback") then
        	if Anim() ~= 21 then
        		ChangeAnim(21)
        	end
        	VelSet(-2.5, 0)
        end
		if not CommandTest("holdback") and not CommandTest("holdfwd") then
            ChangeState(0)
		end
	end,
}

--jump start
M[40] = {
    onEnter = function(_ENV)
    	PhysicsSet(Enums.PhysicsType.S)
    	MoveTypeSet(Enums.MoveType.I)
    	ChangeAnim(40)
    	CtrlSet(false)
    	if CommandTest("holdback") then
    		_ENV.jumpDir = -1
    	elseif CommandTest("holdfwd") then
    		_ENV.jumpDir = 1
    	else
    		_ENV.jumpDir = 0
    	end
    end,
    onUpdate = function(_ENV)
    	if LeftAnimTime() <= 0 then
    	   ChangeState(41)
    	end
    end
}

--jump up
M[41] = {
	onEnter = function(_ENV)
		PhysicsSet(Enums.PhysicsType.A)
		MoveTypeSet(Enums.MoveType.I)
		CtrlSet(true)
		ChangeAnim(41)
		VelSet(_ENV.jumpDir*2, 7)
	end,
	onUpdate = function(_ENV)
		if Vel().y <= 0 then
			ChangeState(44)
		end
	end
}

--jump down
M[44] = {
    onEnter = function(_ENV)
        ChangeAnim(44)
    end,
    onUpdate = function(_ENV)
        if JustOnGround() then
        	ChangeState(47)
        end
    end
}

--land
M[47] = {
	onEnter = function(_ENV)
		MoveTypeSet(Enums.MoveType.I)
		PhysicsSet(Enums.PhysicsType.S)
		CtrlSet(false)
		ChangeAnim(47)
		VelSet(0, 0)
	end,
	onUpdate = function(_ENV)
	    if StateTime() == 3 then
	    	CtrlSet(true)
	    end
		if LeftAnimTime() <= 0 then
		    ChangeState(0)
		end
	end
}

--run
M[100] = {
	onEnter = function(_ENV)
		MoveTypeSet(Enums.MoveType.I)
		PhysicsSet(Enums.PhysicsType.S)
		CtrlSet(true)
		ChangeAnim(100)	
	end,
	onUpdate = function(_ENV)
		VelSet(5, 0)
		if not CommandTest("holdfwd") then
			ChangeState(101)
		end
	end,
}

--run stop
M[101] = {
	onEnter = function(_ENV)
	    MoveTypeSet(Enums.MoveType.I)
		PhysicsSet(Enums.PhysicsType.S)
	    CtrlSet(false)
		if AnimExist(101) then
			ChangeAnim(101)
		else
			ChangeState(0)
		end
	end,
	onUpdate = function(_ENV)
		if LeftAnimTime() <= 0 then
			ChangeState(0)
		end
	end,
}

M[105] = {
    onEnter = function(_ENV)
    	MoveTypeSet(Enums.MoveType.I)
		PhysicsSet(Enums.PhysicsType.S)
		CtrlSet(false)
		ChangeAnim(105)	
    end,
    onUpdate = function(_ENV)
    	if LeftAnimTime(0) <= 0 then
    		ChangeState(106)
    	end
    end
}

M[106] = {
    onEnter = function(_ENV)
    	MoveTypeSet(Enums.MoveType.I)
		PhysicsSet(Enums.PhysicsType.A)
		CtrlSet(false)
		ChangeAnim(106)	
		VelSet(-4, 2)
    end,
    onUpdate = function(_ENV)
    	if JustOnGround() then
    		ChangeState(107)
    	end
    end
}

M[107] = {
    onEnter = function(_ENV)
    	MoveTypeSet(Enums.MoveType.I)
		PhysicsSet(Enums.PhysicsType.S)
		CtrlSet(false)
		ChangeAnim(107)	
		VelSet(0, 0)
    end,
    onUpdate = function(_ENV)
    	if LeftAnimTime() <= 0 then
    		ChangeState(0)
    	end
    end
}

--start guard
M[120] = {
	onEnter = function(_ENV)
	    MoveTypeSet(Enums.MoveType.D)
		CtrlSet(false)
		if PhysicsType() == Enums.PhysicsType.S then
		    ChangeAnim(120)
		else
			ChangeAnim(121)
		end
	end,
	onUpdate = function(_ENV)
	    if LeftAnimTime() <= 0 then
		    if PhysicsType() == Enums.PhysicsType.S then
		        ChangeState(130)
		    else
			    ChangeState(131)
		    end
	    end
	end
}

--guarding stand
M[130] = {
	onEnter = function(_ENV)
		MoveTypeSet(Enums.MoveType.D)
		PhysicsSet(Enums.PhysicsType.S)
		CtrlSet(false)
		ChangeAnim(130)
		VelSet(0, 0)
	end,
	onUpdate = function(_ENV) 
	    if CommandTest("holddown") then
	    	ChangeState(131)
	    end   
	    if not CommandTest("holdback") or P2MoveType() ~= Enums.MoveType.A and StateTime() > 20 then
			ChangeState(140)
		end
	end
}

--guarding crouch
M[131] = {
	onEnter = function(_ENV)
		MoveTypeSet(Enums.MoveType.D)
		PhysicsSet(Enums.PhysicsType.C)
		CtrlSet(false)
		ChangeAnim(131)
		VelSet(0, 0)
	end,
	onUpdate = function(_ENV)
	    if not CommandTest("holddown") then
	    	ChangeState(130)
	    end
		if not CommandTest("holdback") or P2MoveType() ~= Enums.MoveType.A and StateTime() > 20 then
			ChangeState(140)
		end
	end
}

--guard end
M[140] = {
	onEnter = function(_ENV)
		MoveTypeSet(Enums.MoveType.D)
		CtrlSet(false)
		if PhysicsType() == Enums.PhysicsType.S then
		    ChangeAnim(140)
		else
			ChangeAnim(141)
		end
	end,
	onUpdate = function(_ENV)
		if LeftAnimTime() <= 0 then
			if PhysicsType() == Enums.PhysicsType.S then
				ChangeState(0)
			else
				ChangeState(11)
			end
		end
	end
}

--guard hit stand (shaking)
M[150] = {
    onEnter = function(_ENV)
        PhysicsSet(Enums.PhysicsType.S)
        MoveTypeSet(Enums.MoveType.D)
		CtrlSet(false)
    end,
    onUpdate = function(_ENV)
    	ChangeAnim(150)
    	if PhysicsType() == Enums.PhysicsType.S and CommandTest("holddown") then
    		PhysicsSet(Enums.PhysicsType.C)
    	end
    	if PhysicsType() == Enums.PhysicsType.C and not CommandTest("holddown") then
    		PhysicsSet(Enums.PhysicsType.S)
    	end
    	if StateTime() > GetHitVar("guardShakeTime") then
    		if PhysicsType() == Enums.PhysicsType.S then
    		    ChangeState(151)
    		else
    			ChangeState(157)
    		end
    	end
    end	
}

--guard hit stand (knocked back)
M[151] = {
    onEnter = function(_ENV)
        MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.S)
		CtrlSet(false)
		VelSet(GetHitVar("guardVel"))
		ChangeAnim(150)
    end,
    onUpdate = function(_ENV)
        if PhysicsType() == Enums.PhysicsType.S and CommandTest("holddown") then
    		PhysicsSet(Enums.PhysicsType.C)
    	end
    	if PhysicsType() == Enums.PhysicsType.C and not CommandTest("holddown") then
    		PhysicsSet(Enums.PhysicsType.S)
    	end
    	if StateTime() > GetHitVar("guardSlideTime") then
    		ChangeState(130)
    	end
    end	
}

--guard hit crouch (shaking)
M[156] = {
	onEnter = function(_ENV)
	    PhysicsSet(Enums.PhysicsType.C)
        MoveTypeSet(Enums.MoveType.D)
		CtrlSet(false)
    end,
    onUpdate = function(_ENV)
        ChangeAnim(151)
        if PhysicsType() == Enums.PhysicsType.S and CommandTest("holddown") then
    		PhysicsSet(Enums.PhysicsType.C)
    	end
    	if PhysicsType() == Enums.PhysicsType.C and not CommandTest("holddown") then
    		PhysicsSet(Enums.PhysicsType.S)
    	end
    	if StateTime() > GetHitVar("guardShakeTime") then
    		if PhysicsType() == Enums.PhysicsType.S then
    		    ChangeState(151)
    		else
    			ChangeState(157)
    		end
    	end
    end
}

--guard hit crouch (knocked back)
M[157] = {
	onEnter = function(_ENV)
	    MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.S)
		CtrlSet(false)
		VelSet(GetHitVar("guardVel"))
		ChangeAnim(151)
    end,
    onUpdate = function(_ENV) 
        if PhysicsType() == Enums.PhysicsType.S and CommandTest("holddown") then
    		PhysicsSet(Enums.PhysicsType.C)
    	end
    	if PhysicsType() == Enums.PhysicsType.C and not CommandTest("holddown") then
    		PhysicsSet(Enums.PhysicsType.S)
    	end
    	if StateTime() > GetHitVar("guardSlideTime") then
    		ChangeState(131)
    	end
    end
}

--lose
M[170] = {
	onEnter = function(_ENV)
		MoveTypeSet(Enums.MoveType.I)
		PhysicsSet(Enums.PhysicsType.S)
		CtrlSet(false)
		VelSet(0,0)
		ChangeAnim(170)
	end,
	onUpdate = function(_ENV)
	end
}

--win
M[180] = {
	onEnter = function(_ENV)
	    MoveTypeSet(Enums.MoveType.I)
		PhysicsSet(Enums.PhysicsType.S)
		CtrlSet(false)
		VelSet(0,0)
		ChangeAnim(180)
	end,
	onUpdate = function(_ENV)
		
	end
}

--intro
M[190] = {
	onEnter = function(_ENV)
	    MoveTypeSet(Enums.MoveType.I)
		PhysicsSet(Enums.PhysicsType.S)
		CtrlSet(false)
		VelSet(0,0)
		ChangeAnim(190)
	end,
	onUpdate = function(_ENV)
		if LeftAnimTime() <= 0 then
			ChangeState(0)
		end
	end
}

--get-hit-stand(shaking)
M[5000] = {
	onEnter = function(_ENV)
		MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.N)
		VelSet(0, 0)
		CtrlSet(false)	
		ChangeAnim(5000 + 10*GetHitVar("groundType") + GetHitVar("forceLevel"))	
	end,
	onUpdate = function(_ENV)
	    --freeze anim
		ChangeAnim(Anim())
        if StateTime() > GetHitVar("hitShakeTime") then
            ChangeState(5001)
        end
	end,
}

--get-hit-stand(sliding)
M[5001] = {
	onEnter = function(_ENV)
		MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.S)
		CtrlSet(false)
		VelSet(GetHitVar("groundVel"))
		ChangeAnim(5000 + 10*GetHitVar("groundType") + GetHitVar("forceLevel"))
	end,
	onUpdate = function(_ENV)
	    if LeftAnimTime() <= 0 then
	    	ChangeAnim(5005 + 10*GetHitVar("groundType") + GetHitVar("forceLevel"))
	    end
		if StateTime() > GetHitVar("hitSlideTime") then
			ChangeState(0)
		end
	end,
}

--get-hit-crouch(shaking)
M[5010] = {
	onEnter = function(_ENV)
		MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.N)
		VelSet(0, 0)
		CtrlSet(false)	
		ChangeAnim(5020 + GetHitVar("forceLevel"))
	end,
	onUpdate = function(_ENV)
	    --freeze anim
		ChangeAnim(Anim())
        if StateTime() > GetHitVar("hitShakeTime") then
            ChangeState(5011)
        end
	end,
}

--get-hit-crouch(sliding)
M[5011] = {
	onEnter = function(_ENV)
		MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.C)
		CtrlSet(false)
		VelSet(GetHitVar("groundVel"))
		ChangeAnim(5020 + GetHitVar("forceLevel"))
	end,
	onUpdate = function(_ENV)
	    if LeftAnimTime() <= 0 then
	    	ChangeAnim(5025 + GetHitVar("forceLevel"))
	    end
		if StateTime() > GetHitVar("hitSlideTime") then
			ChangeState(11)
		end
	end,
}

--get-hit-air(shaking)
M[5020] = {
	onEnter = function(_ENV)
		MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.N)
		CtrlSet(false)
		VelSet(0, 0)
		ChangeAnim(5030)
	end,
	onUpdate = function(_ENV)
	    ChangeAnim(5030)
		if StateTime() > GetHitVar("hitShakeTime") then
			ChangeState(5021)
		end
	end,
}

--get-hit-air(lose balance)
M[5021] = {
	onEnter = function(_ENV)
		MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.A)
		CtrlSet(false)
		VelSet(GetHitVar("airVel"))
		ChangeAnim(5030)
	end,
	onUpdate = function(_ENV)
		if LeftAnimTime() <= 0 then
			ChangeState(5022)
		end
	end,
}

--air recover
M[5022] = {
	onEnter = function(_ENV)
		MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.A)
		CtrlSet(false)
		ChangeAnim(5040)
	end,
	onUpdate = function(_ENV)
	    HitBy(2, 1, Enums.HitFlag.A, Enums.HitType.Throw)
		if JustOnGround() then
	    	ChangeState(47)
	    end
	end,
}

--enterance of knock away
M[5030] = {
	onEnter = function(_ENV)
		ChangeState(5040 + GetHitVar("knockAwayType")*10)
	end,
	onUpdate = function(_ENV)
		
	end,
}

--knock away default type
-- shaking
M[5040] = {
	onEnter = function (_ENV)
		MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.N)
		ChangeAnim(5030)
		VelSet(0, 0)
	end,
	onUpdate = function(_ENV)
	    ChangeAnim(5030)
	    if StateTime() > GetHitVar("hitShakeTime") then
	    	ChangeState(5041)
	    end
	end,
}

--lose blance
M[5041] = {
	onEnter = function (_ENV)
		MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.A)
		ChangeAnim(5030)
		VelSet(GetHitVar("airVel"))
	end,
	onUpdate = function(_ENV)
	    if LeftAnimTime() <=0 then
	    	ChangeState(5042)
	    end
	end,
}

--air falling
M[5042] = {
	onEnter = function (_ENV)
		MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.A)
		ChangeAnim(5050)
	end,
	onUpdate = function(_ENV)
	    if JustOnGround() then
	    	ChangeState(5100)
	    end
	end,
}

--hit ground
M[5100] = {
	onEnter = function(_ENV)
	    local vel = Vel()
	    _ENV._hitGroundVel = vel
	    MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.C)
		ChangeAnim(5100)
		VelSet(0,0)
		PlaySound("Snd_HitGround", {volume = 1, delay = 0})
	end,
	onUpdate = function(_ENV)
		if LeftAnimTime() <= 0 then
			ChangeState(5160)
		end
	end
}

--lie down
M[5110] = {
	onEnter = function(_ENV)
	    MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.C)
		ChangeAnim(5110)
		VelSet(0,0)
	end,
	onUpdate = function(_ENV)
		if Alive() and StateTime() > 20 then
			ChangeState(5120) --get up
		end
	end
}

M[5120] = {
	onEnter = function(_ENV)
		MoveTypeSet(Enums.MoveType.I)
		PhysicsSet(Enums.PhysicsType.S)
		ChangeAnim(5120)
		VelSet(0,0)
	end,
	onUpdate = function(_ENV)
	    if LeftAnimTime() == 0 then
	    	ChangeState(0)
	    end
    end
}

--ground bounce
M[5160] = {
	onEnter = function(_ENV)
	    MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.A)
		ChangeAnim(5160)
		VelSet(_ENV._hitGroundVel.x*0.5, 2)
	end,
	onUpdate = function(_ENV)
		if JustOnGround() then
			ChangeState(5170)
		end
	end
}

--hit ground again
M[5170] = {
	onEnter = function(_ENV)
	    MoveTypeSet(Enums.MoveType.H)
		PhysicsSet(Enums.PhysicsType.C)
		ChangeAnim(5170)
		VelSet(0,0)
	end,
	onUpdate = function(_ENV)
		if LeftAnimTime() <= 0 then
			ChangeState(5110)
		end
	end
}

M[5900] = {
	onEnter = function(_ENV)
		PhysicsSet(Enums.PhysicsType.S)
	end,
	onUpdate = function(_ENV)
	    if RoundNo() == 0 then
	    	ChangeState(190)
	    else
	    	ChangeState(0)
	    end
	end
}
return M